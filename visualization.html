<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡é‡‘å±æš´éœ²æ¡ˆä¾‹æ•°æ®å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: all 0.3s;
        }

        .search-box:focus {
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .filter-select {
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            cursor: pointer;
            background: white;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-wrapper {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-wrapper h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .case-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 2px;
        }

        .case-human {
            background: #e3f2fd;
            color: #1565c0;
        }

        .case-animal {
            background: #f3e5f5;
            color: #6a1b9a;
        }

        .case-cell {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #667eea;
        }

        .triple-view {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .triple-view h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .triple-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 15px;
        }

        .triple-subject {
            font-weight: bold;
            color: #667eea;
        }

        .triple-predicate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .triple-object {
            color: #333;
            font-weight: 500;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 15px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover {
            background: #667eea;
            color: white;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ é‡é‡‘å±æš´éœ²æ¡ˆä¾‹æ•°æ®å¯è§†åŒ–åˆ†æ</h1>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalRecords">0</div>
                <div class="stat-label">æ€»è®°å½•æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCases">0</div>
                <div class="stat-label">æ€»æ¡ˆä¾‹æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="metalTypes">0</div>
                <div class="stat-label">é‡‘å±ç§ç±»</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="speciesCount">0</div>
                <div class="stat-label">ç‰©ç§æ•°é‡</div>
            </div>
        </div>

        <div class="controls">
            <input type="text" class="search-box" id="searchBox" placeholder="ğŸ” æœç´¢é‡‘å±ç±»å‹ã€ç‰©ç§ã€PMID...">
            <select class="filter-select" id="caseTypeFilter">
                <option value="">æ‰€æœ‰æ¡ˆä¾‹ç±»å‹</option>
                <option value="human">äººç±»</option>
                <option value="animal">åŠ¨ç‰©</option>
                <option value="cell">ç»†èƒ</option>
            </select>
            <select class="filter-select" id="metalTypeFilter">
                <option value="">æ‰€æœ‰é‡‘å±ç±»å‹</option>
            </select>
            <select class="filter-select" id="yearFilter">
                <option value="">æ‰€æœ‰å¹´ä»½</option>
            </select>
        </div>

        <div class="triple-view">
            <h3>ğŸ“Š ä¸‰å…ƒç»„æ•°æ®å±•ç¤ºï¼ˆä¸»è¯­-å…³ç³»-å®¾è¯­ï¼‰</h3>
            <div id="tripleContainer">
                <div style="text-align:center;padding:20px;color:#999;">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-wrapper">
                <h3>é‡‘å±ç±»å‹åˆ†å¸ƒ</h3>
                <canvas id="metalChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h3>æ¡ˆä¾‹ç±»å‹åˆ†å¸ƒ</h3>
                <canvas id="caseTypeChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h3>å¹´ä»½åˆ†å¸ƒè¶‹åŠ¿</h3>
                <canvas id="yearChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h3>æš´éœ²é€”å¾„ç»Ÿè®¡</h3>
                <canvas id="exposureChart"></canvas>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>PMID</th>
                        <th>å¹´ä»½</th>
                        <th>æ¡ˆä¾‹æ•°</th>
                        <th>é‡‘å±ç±»å‹</th>
                        <th>æ¡ˆä¾‹ç±»å‹</th>
                        <th>ç‰©ç§</th>
                        <th>æš´éœ²å‰‚é‡</th>
                    </tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let chartInstances = {
            metalChart: null,
            caseTypeChart: null,
            yearChart: null,
            exposureChart: null
        };

        async function loadData() {
            try {
                const response = await fetch('temp1.txt');
                const text = await response.text();
                const lines = text.split('\n').slice(1);
                
                allData = lines.filter(line => line.trim()).map(line => {
                    const parts = line.split('\t');
                    if (parts.length < 5) return null;
                    
                    try {
                        const cases = parts[4] === 'æ— æ¡ˆä¾‹' ? [] : JSON.parse(parts[4]);
                        return {
                            sessionId: parts[0],
                            caseCount: parseInt(parts[1]) || 0,
                            pmid: parts[2],
                            year: parts[3],
                            cases: cases
                        };
                    } catch (e) {
                        return null;
                    }
                }).filter(item => item !== null);

                filteredData = [...allData];
                updateStatistics();
                populateFilters();
                renderCharts();
                renderTriples();
                renderTable();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('dataTable').innerHTML = 
                    '<tr><td colspan="7" style="text-align:center;color:red;">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿temp1.txtæ–‡ä»¶å­˜åœ¨</td></tr>';
            }
        }

        function updateStatistics() {
            const totalRecords = filteredData.length;
            const totalCases = filteredData.reduce((sum, record) => sum + record.caseCount, 0);
            
            const metalTypesSet = new Set();
            const speciesSet = new Set();
            
            filteredData.forEach(record => {
                record.cases.forEach(c => {
                    if (c.metal_type) metalTypesSet.add(c.metal_type);
                    if (c.species) speciesSet.add(c.species);
                });
            });

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('totalCases').textContent = totalCases;
            document.getElementById('metalTypes').textContent = metalTypesSet.size;
            document.getElementById('speciesCount').textContent = speciesSet.size;
        }

        function populateFilters() {
            const metalTypes = new Set();
            const years = new Set();
            
            allData.forEach(record => {
                if (record.year) years.add(record.year);
                record.cases.forEach(c => {
                    if (c.metal_type) metalTypes.add(c.metal_type);
                });
            });

            const metalFilter = document.getElementById('metalTypeFilter');
            Array.from(metalTypes).sort().forEach(metal => {
                const option = document.createElement('option');
                option.value = metal;
                option.textContent = metal;
                metalFilter.appendChild(option);
            });

            const yearFilter = document.getElementById('yearFilter');
            Array.from(years).sort().reverse().forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
        }

        function renderTriples() {
            const container = document.getElementById('tripleContainer');
            const sampleTriples = [];
            
            filteredData.slice(0, 10).forEach(record => {
                record.cases.forEach(c => {
                    if (c.species && c.metal_type) {
                        sampleTriples.push({
                            subject: c.species,
                            predicate: 'æš´éœ²äº',
                            object: c.metal_type
                        });
                        
                        if (c.exposure_route && c.exposure_route.length > 0) {
                            sampleTriples.push({
                                subject: c.metal_type,
                                predicate: 'é€šè¿‡é€”å¾„',
                                object: c.exposure_route.join(', ')
                            });
                        }
                        
                        if (c.exposure_dose && c.exposure_dose.value) {
                            sampleTriples.push({
                                subject: c.species,
                                predicate: 'å‰‚é‡',
                                object: `${c.exposure_dose.value} ${c.exposure_dose.unit || ''}`
                            });
                        }
                    }
                });
            });

            if (sampleTriples.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">æš‚æ— ä¸‰å…ƒç»„æ•°æ®</div>';
            } else {
                container.innerHTML = sampleTriples.slice(0, 15).map(triple => `
                    <div class="triple-item">
                        <div class="triple-subject">${triple.subject}</div>
                        <div class="triple-predicate">${triple.predicate}</div>
                        <div class="triple-object">${triple.object}</div>
                    </div>
                `).join('');
            }
        }

        function renderCharts() {
            renderMetalChart();
            renderCaseTypeChart();
            renderYearChart();
            renderExposureChart();
        }

        function renderMetalChart() {
            const metalCounts = {};
            filteredData.forEach(record => {
                record.cases.forEach(c => {
                    const metal = c.metal_type || 'æœªçŸ¥';
                    metalCounts[metal] = (metalCounts[metal] || 0) + 1;
                });
            });

            const sortedMetals = Object.entries(metalCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (chartInstances.metalChart) {
                chartInstances.metalChart.destroy();
            }

            const ctx = document.getElementById('metalChart');
            chartInstances.metalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedMetals.map(m => m[0]),
                    datasets: [{
                        label: 'æ¡ˆä¾‹æ•°é‡',
                        data: sortedMetals.map(m => m[1]),
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderCaseTypeChart() {
            const typeCounts = { human: 0, animal: 0, cell: 0 };
            filteredData.forEach(record => {
                record.cases.forEach(c => {
                    if (c.case_type) {
                        typeCounts[c.case_type] = (typeCounts[c.case_type] || 0) + 1;
                    }
                });
            });

            if (chartInstances.caseTypeChart) {
                chartInstances.caseTypeChart.destroy();
            }

            const ctx = document.getElementById('caseTypeChart');
            chartInstances.caseTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['äººç±»', 'åŠ¨ç‰©', 'ç»†èƒ'],
                    datasets: [{
                        data: [typeCounts.human, typeCounts.animal, typeCounts.cell],
                        backgroundColor: [
                            'rgba(21, 101, 192, 0.7)',
                            'rgba(106, 27, 154, 0.7)',
                            'rgba(46, 125, 50, 0.7)'
                        ],
                        borderColor: [
                            'rgba(21, 101, 192, 1)',
                            'rgba(106, 27, 154, 1)',
                            'rgba(46, 125, 50, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderYearChart() {
            const yearCounts = {};
            filteredData.forEach(record => {
                if (record.year) {
                    yearCounts[record.year] = (yearCounts[record.year] || 0) + 1;
                }
            });

            const sortedYears = Object.entries(yearCounts).sort((a, b) => a[0] - b[0]);

            if (chartInstances.yearChart) {
                chartInstances.yearChart.destroy();
            }

            const ctx = document.getElementById('yearChart');
            chartInstances.yearChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedYears.map(y => y[0]),
                    datasets: [{
                        label: 'è®°å½•æ•°é‡',
                        data: sortedYears.map(y => y[1]),
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderExposureChart() {
            const exposureCounts = {};
            filteredData.forEach(record => {
                record.cases.forEach(c => {
                    if (c.exposure_route && Array.isArray(c.exposure_route)) {
                        c.exposure_route.forEach(route => {
                            exposureCounts[route] = (exposureCounts[route] || 0) + 1;
                        });
                    }
                });
            });

            const sortedExposures = Object.entries(exposureCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (chartInstances.exposureChart) {
                chartInstances.exposureChart.destroy();
            }

            const ctx = document.getElementById('exposureChart');
            chartInstances.exposureChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedExposures.map(e => e[0]),
                    datasets: [{
                        label: 'æ¡ˆä¾‹æ•°é‡',
                        data: sortedExposures.map(e => e[1]),
                        backgroundColor: 'rgba(46, 125, 50, 0.7)',
                        borderColor: 'rgba(46, 125, 50, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = pageData.map(record => {
                const metalTypes = [...new Set(record.cases.map(c => c.metal_type))].join(', ');
                const caseTypes = [...new Set(record.cases.map(c => c.case_type))];
                const species = [...new Set(record.cases.map(c => c.species))].slice(0, 2).join(', ');
                const doses = record.cases
                    .filter(c => c.exposure_dose && c.exposure_dose.value)
                    .map(c => `${c.exposure_dose.value} ${c.exposure_dose.unit || ''}`)
                    .slice(0, 2)
                    .join(', ');

                const badges = caseTypes.map(type => 
                    `<span class="case-badge case-${type}">${type}</span>`
                ).join('');

                return `
                    <tr>
                        <td>${record.pmid || '-'}</td>
                        <td>${record.year || '-'}</td>
                        <td>${record.caseCount}</td>
                        <td>${metalTypes || '-'}</td>
                        <td>${badges || '-'}</td>
                        <td>${species || '-'}</td>
                        <td>${doses || '-'}</td>
                    </tr>
                `;
            }).join('');

            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            let html = '';
            if (currentPage > 1) {
                html += `<button class="page-btn" onclick="changePage(${currentPage - 1})">Â« ä¸Šä¸€é¡µ</button>`;
            }
            
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }
            
            if (currentPage < totalPages) {
                html += `<button class="page-btn" onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é¡µ Â»</button>`;
            }
            
            pagination.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            renderTable();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const caseTypeFilter = document.getElementById('caseTypeFilter').value;
            const metalTypeFilter = document.getElementById('metalTypeFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;

            filteredData = allData.filter(record => {
                if (yearFilter && record.year !== yearFilter) return false;
                
                const matchesSearch = !searchTerm || 
                    record.pmid?.toLowerCase().includes(searchTerm) ||
                    record.cases.some(c => 
                        c.metal_type?.toLowerCase().includes(searchTerm) ||
                        c.species?.toLowerCase().includes(searchTerm)
                    );
                
                const matchesCaseType = !caseTypeFilter || 
                    record.cases.some(c => c.case_type === caseTypeFilter);
                
                const matchesMetalType = !metalTypeFilter || 
                    record.cases.some(c => c.metal_type === metalTypeFilter);
                
                return matchesSearch && matchesCaseType && matchesMetalType;
            });

            currentPage = 1;
            updateStatistics();
            renderCharts();
            renderTriples();
            renderTable();
        }

        document.getElementById('searchBox').addEventListener('input', applyFilters);
        document.getElementById('caseTypeFilter').addEventListener('change', applyFilters);
        document.getElementById('metalTypeFilter').addEventListener('change', applyFilters);
        document.getElementById('yearFilter').addEventListener('change', applyFilters);

        loadData();
    </script>
</body>
</html>
